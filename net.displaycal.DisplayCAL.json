{
    "id": "net.displaycal.DisplayCAL",
    "runtime": "org.freedesktop.Platform",
    "sdk": "org.freedesktop.Sdk",
    "runtime-version": "25.08",
    "rename-desktop-file": "displaycal.desktop",
    "rename-icon": "displaycal",
    "copy-icon": true,
    "command": "displaycal",
    "finish-args": [
        "--share=ipc",
        /* X11 is required even with Wayland. Not as a fallback */
        "--socket=x11",
        "--socket=wayland",
        "--device=all",
        "--share=network",
        "--system-talk-name=org.freedesktop.ColorManager",
        "--talk-name=org.freedesktop.PowerManagement",
        "--talk-name=org.freedesktop.ScreenSaver",
        "--talk-name=org.gnome.Mutter.DisplayConfig",
        "--talk-name=org.gnome.SessionManager",
        "--talk-name=org.gnome.SettingsDaemon.Power"
    ],
    "cleanup": [
        "/share/man"
    ],
    "modules": [
        {
            "name": "jam",
            "cleanup": [
                "*"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "http://www.argyllcms.com/ajam-2.5.2-1.3.3.tgz",
                    "sha256": "57c3768bd7954ea97600b823018c1d89419f52e0ea385ac10591ad16716dca26"
                },
                {
                    "type": "patch",
                    "path": "patches/bjam-build.patch"
                },
                {
                    "type": "shell",
                    "commands": [
                        "cp -p /usr/share/automake-*/config.{sub,guess} builds/unix"
                    ]
                }
            ]
        },
        {
            "name": "argyllcms",
            "buildsystem": "simple",
            "build-commands": [
                "make install"
            ],
            "post-install": [
                "install -Dm755 -t ${FLATPAK_DEST}/bin bin/*"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://www.argyllcms.com/Argyll_V3.3.0_src.zip",
                    "sha256": "69db1c9ef66f8cacbbbab4ed9910147de6100c3afd17a0a8c12e6525b778e8ce"
                },
                {
                    "type": "patch",
                    "paths": [
                        "patches/argyllcms-tiff-lzma.patch",
                        "patches/argyllcms-build.patch"
                    ]
                },
                {
                    "type": "shell",
                    "commands": [
                        "cp -p /usr/share/automake-*/config.{sub,guess} tiff/config",
                        "cp -p /usr/share/automake-*/config.{sub,guess} jpeg"
                    ]
                }
            ]
        },
        "python3-requirements.json",
        {
            "name": "python-wxPython",
            "buildsystem": "simple",
            "build-options": {
                "arch": {
                    "aarch64": {
                        "ldflags": "-L/usr/lib/aarch64-linux-gnu"
                    },
                    "x86_64": {
                        "ldflags": "-L/usr/lib/x86_64-linux-gnu"
                    }
                }
            },
            "build-commands": [
                "pip install --no-index --find-links=\"file://${PWD}\" --prefix=${FLATPAK_DEST} wxPython --no-build-isolation"
            ],
            "sources": [
                {
                    "type": "file",
                    "url": "https://files.pythonhosted.org/packages/a4/f5/8c272764770f47fd419cc2eff4c4fa1c0681c71bcc2f3158b3a83d1339ff/wxPython-4.2.2.tar.gz",
                    "sha256": "5dbcb0650f67fdc2c5965795a255ffaa3d7b09fb149aa8da2d0d9aa44e38e2ba"
                }
            ]
        },
        {
            "name": "python-dbus",
            "buildsystem": "simple",
            "build-commands": [
                "pip install --no-index --find-links=\"file://${PWD}\" --prefix=${FLATPAK_DEST} dbus-python --no-build-isolation"
            ],
            "sources": [
                {
                    "type": "file",
                    "url": "https://files.pythonhosted.org/packages/b1/5c/ccfc167485806c1936f7d3ba97db6c448d0089c5746ba105b6eb22dba60e/dbus-python-1.2.18.tar.gz",
                    "sha256": "92bdd1e68b45596c833307a5ff4b217ee6929a1502f5341bae28fd120acf7260"
                }
            ]
        },
        {
            "name": "displaycal",
            "buildsystem": "simple",
            "build-options": {
                "cflags": "-Wno-error=implicit-function-declaration"
            },
            "build-commands": [
                "pip install --prefix=/app --root=/ --no-build-isolation .",
                "./export-app.sh displaycal-apply-profiles apply-profiles",
                "./export-app.sh displaycal-vrml-to-x3d-converter vrml-to-x3d-converter",
                "./export-app.sh displaycal-synthprofile synthprofile",
                "./export-app.sh displaycal-profile-info profile-info",
                "./export-app.sh displaycal-curve-viewer curve-viewer",
                "./export-app.sh displaycal-scripting-client scripting-client",
                "./export-app.sh displaycal-testchart-editor testchart-editor",
                "./export-app.sh displaycal-3dlut-maker 3dlut-maker"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/eoyilmaz/displaycal-py3/releases/download/3.9.17/DisplayCAL-3.9.17.tar.gz",
                    "sha256": "715f31d47c7e29052138eceac3ff3d420a19f7ef36be1c06ae11b5dcaa44f55c"
                },
                {
                    "type": "script",
                    "dest-filename": "export-app.sh",
                    "commands": [
                        "SOURCE=$1",
                        "DEST=$2",
                        "mv ${FLATPAK_DEST}/share/applications/${SOURCE}.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.${DEST}.desktop",
                        "for s in 16 22 24 32 48 128 256; do cp ${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/${SOURCE}.png ${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/${FLATPAK_ID}.${DEST}.png  ; done",
                        "desktop-file-edit --set-icon=${FLATPAK_ID}.${DEST} ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.${DEST}.desktop"
                    ]
                }
            ]
        }
    ]
}

{
    "id": "net.displaycal.DisplayCAL",
    "runtime": "org.freedesktop.Platform",
    "sdk": "org.freedesktop.Sdk",
    "runtime-version": "22.08",
    "rename-desktop-file": "displaycal.desktop",
    "rename-icon": "displaycal",
    "copy-icon": true,
    "command": "displaycal",
    "finish-args": [
        "--share=ipc",
        /* X11 is required even with Wayland. Not as a fallback */
        "--socket=x11",
        "--socket=wayland",
        "--device=all",
        /* Need network access to download hardware support as needed */
        "--share=network",
        "--system-talk-name=org.freedesktop.ColorManager",
        "--talk-name=org.freedesktop.PowerManagement",
        "--talk-name=org.freedesktop.ScreenSaver",
        "--talk-name=org.gnome.Mutter.DisplayConfig",
        "--talk-name=org.gnome.SessionManager",
        "--talk-name=org.gnome.SettingsDaemon.Power"
    ],
    "cleanup": [
        "/share/man"
    ],
    "modules": [
        {
            "name": "jam",
            "cleanup": [
                "*"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "http://www.argyllcms.com/ajam-2.5.2-1.3.3.tgz",
                    "sha256": "57c3768bd7954ea97600b823018c1d89419f52e0ea385ac10591ad16716dca26"
                },
                {
                    "type": "shell",
                    "commands": [
                        "cp -p /usr/share/automake-*/config.{sub,guess} builds/unix"
                    ]
                }
            ]
        },
        {
            "name": "argyllcms",
            "buildsystem": "simple",
            "build-commands": [
                "make install"
            ],
            "post-install": [
                "install -Dm755 --target ${FLATPAK_DEST}/bin bin/*"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://www.argyllcms.com/Argyll_V2.3.1_src.zip",
                    "sha256": "bd0bcf58cec284824b79ff55baa242903ed361e12b1b37e12228679f9754961c"
                },
                {
                    "type": "patch",
                    "path": "patches/argyllcms-tiff-lzma.patch"
                },
                {
                    "type": "shell",
                    "commands": [
                        "cp -p /usr/share/automake-*/config.{sub,guess} tiff/config",
                        "cp -p /usr/share/automake-*/config.{sub,guess} jpeg"
                    ]
                }
            ]
        },
        "python3-requirements.json",
        {
            "name": "python-wxPython",
            "buildsystem": "simple",
            "build-options": {
                "arch": {
                    "aarch64": {
                        "ldflags": "-L/usr/lib/aarch64-linux-gnu"
                    },
                    "x86_64": {
                        "ldflags": "-L/usr/lib/x86_64-linux-gnu"
                    }
                }
            },
            "build-commands": [
                "pip install --no-index --find-links=\"file://${PWD}\" --prefix=${FLATPAK_DEST} wxPython"
            ],
            "sources": [
                {
                    "type": "file",
                    "url": "https://files.pythonhosted.org/packages/65/eb/1f97cb97bfc2390a276969c6fae16075da282f5058082d4cb10c6c5c1dba/six-1.14.0-py2.py3-none-any.whl",
                    "sha256": "8f3cd2e254d8f793e7f3d6d9df77b92252b52637291d0f0da013c76ea2724b6c"
                },
                {
                    "type": "file",
                    "url": "https://files.pythonhosted.org/packages/d9/33/b616c7ed4742be6e0d111ca375b41379607dc7cc7ac7ff6aead7a5a0bf53/wxPython-4.2.0.tar.gz",
                    "sha256": "663cebc4509d7e5d113518865fe274f77f95434c5d57bc386ed58d65ceed86c7"
                }
            ]
        },
        {
            "name": "python-dbus",
            "buildsystem": "simple",
            "build-commands": [
                "pip install --no-index --find-links=\"file://${PWD}\" --prefix=${FLATPAK_DEST} dbus-python"
            ],
            "sources": [
                {
                    "type": "file",
                    "url": "https://files.pythonhosted.org/packages/b1/5c/ccfc167485806c1936f7d3ba97db6c448d0089c5746ba105b6eb22dba60e/dbus-python-1.2.18.tar.gz",
                    "sha256": "92bdd1e68b45596c833307a5ff4b217ee6929a1502f5341bae28fd120acf7260"
                }
            ]
        },
        {
            "name": "displaycal",
            "buildsystem": "simple",
            "build-commands": [
                "pip install --prefix=/app --root=/ --no-build-isolation .",
                "./export-app.sh displaycal-apply-profiles apply-profiles",
                "./export-app.sh displaycal-vrml-to-x3d-converter vrml-to-x3d-converter",
                "./export-app.sh displaycal-synthprofile synthprofile",
                "./export-app.sh displaycal-profile-info profile-info",
                "./export-app.sh displaycal-curve-viewer curve-viewer",
                "./export-app.sh displaycal-scripting-client scripting-client",
                "./export-app.sh displaycal-testchart-editor testchart-editor",
                "./export-app.sh displaycal-3dlut-maker 3dlut-maker"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/eoyilmaz/displaycal-py3/releases/download/3.9.10/DisplayCAL-3.9.10.tar.gz",
                    "sha256": "a031c355bd33b800b8f723df98d7bbc6e14a680d414591abef95f0b0baae807b"
                },
                {
                    "type": "patch",
                    "path": "patches/displaycal-fixes.patch"
                },
                {
                    "type": "script",
                    "dest-filename": "export-app.sh",
                    "commands": [
                        "SOURCE=$1",
                        "DEST=$2",
                        "mv ${FLATPAK_DEST}/share/applications/${SOURCE}.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.${DEST}.desktop",
                        "for s in 16 22 24 32 48 128 256; do cp ${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/${SOURCE}.png ${FLATPAK_DEST}/share/icons/hicolor/${s}x${s}/apps/${FLATPAK_ID}.${DEST}.png  ; done",
                        "desktop-file-edit --set-key=Icon --set-value=${FLATPAK_ID}.${DEST} ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.${DEST}.desktop"
                    ]
                }
            ]
        }
    ]
}
